# GitHub Actions CI/CD Pipeline
# ==============================
# Runs tests, linting, builds Docker images, and pushes to GitHub Container Registry

name: MLOps CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  # Scheduled smoke test (runs daily at 6 AM UTC)
  schedule:
    - cron: '0 6 * * *'
  # Manual trigger
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_API: ${{ github.repository }}/api
  IMAGE_NAME_TRAIN: ${{ github.repository }}/trainer

jobs:
  # =============================================================================
  # JOB 1: Lint & Code Quality
  # =============================================================================
  lint:
    name: ðŸ” Lint & Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install linting dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort

      - name: Run flake8 (linter)
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics

      - name: Check code formatting with black
        run: |
          black --check --diff src/ || echo "Code formatting issues found (non-blocking)"

      - name: Check import sorting with isort
        run: |
          isort --check-only --diff src/ || echo "Import sorting issues found (non-blocking)"

  # =============================================================================
  # JOB 2: Unit Tests
  # =============================================================================
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov httpx

      - name: Run tests with coverage
        run: |
          pytest tests/ -v --cov=src --cov-report=xml --cov-report=term-missing

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

  # =============================================================================
  # JOB 3: Build Docker Images
  # =============================================================================
  build:
    name: ðŸ³ Build Docker Images
    runs-on: ubuntu-latest
    needs: test
    
    outputs:
      api_image_tag: ${{ steps.meta_api.outputs.tags }}
      train_image_tag: ${{ steps.meta_train.outputs.tags }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for API image
        id: meta_api
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_API }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Extract metadata for Trainer image
        id: meta_train
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_TRAIN }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.api
          push: true
          tags: ${{ steps.meta_api.outputs.tags }}
          labels: ${{ steps.meta_api.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Trainer image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.train
          push: true
          tags: ${{ steps.meta_train.outputs.tags }}
          labels: ${{ steps.meta_train.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # =============================================================================
  # JOB 4: Smoke Test (Continuous Training Check)
  # =============================================================================
  smoke-test:
    name: ðŸ”¥ Smoke Test (Quick Training Run)
    runs-on: ubuntu-latest
    needs: build
    # Run on schedule OR manual trigger OR main branch push
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run smoke test (quick training with subset)
        run: |
          echo "ðŸ”¥ Running smoke test with minimal data subset..."
          python -c "
          import sys
          sys.path.insert(0, '.')
          
          from src.data.data_loader import load_california_housing
          from src.data.preprocessing import DataPreprocessor
          from src.models.model import get_model
          from sklearn.model_selection import train_test_split
          
          # Load small subset (1000 samples)
          df = load_california_housing().head(1000)
          print(f'âœ… Loaded {len(df)} samples')
          
          # Preprocess
          preprocessor = DataPreprocessor()
          X, y = preprocessor.prepare_features(df)
          X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)
          print(f'âœ… Preprocessed: train={len(X_train)}, test={len(X_test)}')
          
          # Quick training with minimal parameters (like epochs=1)
          model = get_model('gradient_boosting', {'n_estimators': 10, 'max_depth': 3})
          model.fit(X_train, y_train)
          print('âœ… Model trained successfully')
          
          # Validate predictions
          score = model.score(X_test, y_test)
          print(f'âœ… Test RÂ² Score: {score:.4f}')
          
          # Sanity check
          assert score > 0.5, f'Model score too low: {score}'
          print('ðŸŽ‰ Smoke test PASSED!')
          "

      - name: Validate API starts correctly
        run: |
          echo "ðŸ” Testing API startup..."
          timeout 30 python -c "
          import sys
          sys.path.insert(0, '.')
          from src.api.main import app
          print('âœ… FastAPI app imports successfully')
          " || echo "API import check completed"

  # =============================================================================
  # JOB 5: Security Scan (Optional)
  # =============================================================================
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail on vulnerabilities (informational)

  # =============================================================================
  # JOB 6: Notification
  # =============================================================================
  notify:
    name: ðŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [lint, test, build, smoke-test]
    if: always()
    
    steps:
      - name: Pipeline Summary
        run: |
          echo "## ðŸ“Š CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Test | ${{ needs.smoke-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
